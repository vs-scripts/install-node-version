#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

node --eval "
const { execSync } = require('child_process');

try {
  const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf-8' })
    .trim()
    .split('\n')
    .filter(Boolean);

  const fileCount = stagedFiles.length;

  if (fileCount === 0) {
    console.error(JSON.stringify({
      status: 'error',
      code: 'NO_FILES_STAGED',
      message: 'No files staged for commit'
    }));
    process.exit(1);
  }

  if (fileCount > 1) {
    console.error(JSON.stringify({
      status: 'error',
      code: 'ATOMIC_COMMIT_REQUIRED',
      message: \`Atomic commits required (\${fileCount} files staged)\`,
      fileCount,
      files: stagedFiles
    }));
    process.exit(1);
  }

  process.exit(0);
} catch (error) {
  console.error(JSON.stringify({
    status: 'error',
    code: 'HOOK_ERROR',
    message: error.message
  }));
  process.exit(1);
}
"
